# サビアンシンボル機能 開発手順書

## 1. 概要

この手順書は、既存のホロスコープ計算アプリケーションにサビアンシンボル表示機能を追加するための開発手順を記述します。

## 2. 開発環境

既存のプロジェクト環境（Python, Flask, swisseph, JavaScript, HTML, CSS）を使用します。

## 3. データ準備

1.  **サビアンシンボルデータの作成:**
    *   360個のサビアンシンボル（各星座宮の1度から30度まで）の日本語詩文データを準備します。
    *   データはJSONファイル形式で作成し、`data/sabian_symbols.json` として保存します。
    *   JSONの構造例:
        ```json
        {
          "Aries": {
            "1": "牡羊座1度: 女性が水から上がり、アザラシも上がり彼女を抱く。",
            "2": "牡羊座2度: グループを楽しませているコメディアン。",
            // ... 各度数に対応する詩文 ...
            "30": "牡羊座30度: アヒル池とそれが育むヒナたち。"
          },
          "Taurus": {
            "1": "牡牛座1度: 清らかな山の小川。",
            // ... 以下、魚座30度まで続く ...
          }
        }
        ```

## 4. バックエンド実装 (`utils.py`)

1.  **サビアンシンボルデータ読み込み機能の追加:**
    *   `sabian_symbols_data = {}` のようなグローバル変数を定義します。
    *   `load_sabian_symbols()` 関数を作成します。
        *   アプリケーション起動時に一度だけ `data/sabian_symbols.json` を読み込み、`sabian_symbols_data` に格納します。
        *   ファイルが存在しない場合やJSONパースエラーの場合の適切なエラーハンドリング（ログ出力など）を行います。
2.  **サビアンシンボル取得関数の作成:**
    *   `get_sabian_symbol(longitude, sign_name_en)` 関数を作成します。
        *   引数:
            *   `longitude`: 天体の黄経（0.00 ～ 359.99）。
            *   `sign_name_en`: 黄経から特定される星座の英語名（例: "Aries", "Taurus"）。これは既存の星座特定ロジックで取得できる想定。
        *   処理内容:
            *   `longitude` をその星座内の度数（0.00 ～ 29.99）に変換します。
            *   サビアン度数は1から30のため、計算した度数に1を加え、小数点以下を切り捨てて整数にします（例: 0.0度～0.99度は1度、1.0度～1.99度は2度）。
            *   `sabian_symbols_data` から `sign_name_en` と計算したサビアン度数（文字列キー）を使って詩文を検索します。
            *   詩文が見つかればそれを返し、見つからなければ空文字列または「該当なし」のようなメッセージを返します。
3.  **既存ホロスコープ計算関数への組み込み:**
    *   `calculate_horoscope` 関数の変更:
        *   各ネイタル天体・感受点の情報を処理する際に、その天体の黄経と星座名を使って `get_sabian_symbol()` を呼び出します。
        *   戻り値の各天体情報の辞書に、キー `sabian_symbol` とその値（取得した詩文）を追加します。
        *   例: `{'name': '太陽', 'longitude': 123.45, 'sign': '獅子座', 'degree_str': '3°27'', 'sabian_symbol': '獅子座4度: 正装した男と角を刈られた鹿。'}`
    *   `calculate_transits` 関数の変更:
        *   `transit_positions` を生成する際に、各トランジット天体の黄経と星座名を使って `get_sabian_symbol()` を呼び出します。
        *   戻り値の `transit_positions` 内の各天体情報辞書に、キー `sabian_symbol` とその値を追加します。

## 5. バックエンド実装 (`app.py`)

1.  **サビアンシンボルデータの初期ロード:**
    *   アプリケーション起動時（例: `create_app` ファクトリ内や、モジュールレベル）に `utils.load_sabian_symbols()` を一度だけ呼び出します。
2.  **テンプレートへのデータ連携:**
    *   `/calculate` ルートで `calculate_horoscope` および `calculate_transits` から返されるデータにサビアンシンボルが含まれているため、特に変更は不要ですが、`result` 辞書に正しく格納されていることを確認します。

## 6. フロントエンド実装 (`result.html`)

1.  **ネイタル天体テーブルへのサビアンシンボル表示追加:**
    *   既存のネイタル天体情報を表示するテーブル (`<table>`) に「サビアンシンボル」の列ヘッダ (`<th>`) を追加します。
    *   各天体の行 (`<tr>`) に、サビアンシンボルを表示するためのセル (`<td>`) を追加し、`{{ planet.sabian_symbol }}` のようにして詩文を表示します。
    *   **UI/UX改善:**
        *   詩文が長いため、セルには詩文の冒頭部分のみを表示し、全文はツールチップ（例: `title`属性を使用）や、クリックで表示されるモーダルウィンドウに表示するようJavaScriptで制御します。
        *   特定の天体（例: 太陽、月、ASC、MC）のサビアンシンボルセルに特別なクラスを付与し、CSSで目立たせるか、デフォルトで詳細を表示するようにします。
2.  **トランジット天体テーブルへのサビアンシンボル表示追加:**
    *   既存のトランジット天体情報を表示するテーブルに同様の変更を加えます。
3.  **モーダルウィンドウ/アコーディオンの実装 (UI/UX改善):**
    *   サビアンシンボル全文や解説（もしあれば）を表示するためのモーダルウィンドウのHTML構造を定義し、CSSでスタイリングします。
    *   天体のサビアンシンボル表示部分をクリックした際に、対応する詩文をモーダルに表示するJavaScriptロジックを実装します。
    *   あるいは、アコーディオン形式で表示/非表示を切り替えられるようにします。

## 7. フロントエンド実装 (`style.css`)

1.  **サビアンシンボル表示スタイルの追加:**
    *   テーブル内のサビアンシンボルセルの幅、文字の折り返し (`word-break: break-all;`) などを調整します。
    *   ツールチップやモーダルウィンドウのスタイルを定義します。
    *   詩文の雰囲気に合わせたフォントや配色を検討し、適用します。
    *   UI/UX改善で提案された視覚的要素（アイコン、背景）のスタイルを追加します。

## 8. テスト

-   `data/sabian_symbols.json` が正しく読み込まれるか確認します。
-   各天体の度数（特に境界値: 0度、29.9度など）に対して、正しいサビアンシンボル（度数が1加算されたもの）が表示されるか確認します。
-   ネイタルチャート、トランジットチャートの両方で、すべての対象天体についてサビアンシンボルが表示されることを確認します。
-   サビアンシンボルデータが存在しない星座や度数（通常発生しないはずだが）の場合のフォールバック処理を確認します。
-   フロントエンドでの表示（ツールチップ、モーダル、アコーディオンなど）が意図通りに動作するか確認します。
-   表示レイアウトが主要なブラウザで崩れていないか確認します。

## 9. ドキュメント

-   追加・修正したコードに適切なコメントを記述します。
-   サビアンシンボルデータの出典や参照元があれば、コメント等で記録します。
-   (必要であれば) `README.md` に機能追加に関する情報を追記します。 