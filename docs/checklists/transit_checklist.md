# トランジット（経過）機能 開発チェックリスト

## 1. 要件定義・設計

- [ ] **要件確認:** `transit_requirements.md` の内容を確認し、実装範囲を明確にする。
- [x] **トランジット用オーブ決定:** トランジット-ネイタルアスペクト計算に使用するオーブ値を決定する（例: 合/衝は5度、三分/四分は4度、六分は3度など）。 (utils.py に TRANSIT_ASPECTS として定義)
- [x] **データ構造設計:** `utils.calculate_transits` 関数の戻り値、`app.py` でテンプレートに渡す `result` 辞書の詳細な構造を決定する。 (実装済み)
- [x] **表示設計:** `result.html` に追加するトランジット情報（位置テーブル、アスペクトリスト）の具体的な表示レイアウトを決定する。 (実装済み)
- [ ] **追加要件:** トランジット天体の位置とネイタル天体とのアスペクトに基づき、一般的な未来予測のヒントとなる読み解き文章を生成・表示する。

## 2. バックエンド実装 (`utils.py`)

- [x] トランジット用オーブの定数を定義する (例: `TRANSIT_ASPECT_ORBS`)。(TRANSIT_ASPECTS として定義済み)
- [x] `calculate_transits(jd_ut_transit, natal_point_angles_raw)` 関数を作成する。
    - [x] 引数で受け取った `jd_ut_transit` を使い、トランジット天体（太陽～冥王星）の位置を計算する。
    - [x] トランジット天体の位置をフォーマット（星座名、度数文字列）し、辞書に格納する。
    - [x] トランジット天体と `natal_point_angles_raw` を使用し、トランジット-ネイタルアスペクトを計算するロジックを実装する（オーブはトランジット用を使用）。
    - [x] 計算したアスペクト情報（トランジット天体名、ネイタル天体名、種類、オーブ、記号などを含む辞書のリスト）を作成する。
    - [x] フォーマット済みトランジット位置辞書と、トランジット-ネイタルアスペクトリストを含む辞書を返す。
    - [x] **追加:** トランジット-ネイタルアスペクトに基づいた解釈文を生成するロジックを追加し、戻り値に含める。
- [x] 必要なヘルパー関数（`get_sign`, `format_degree` など）や定数（`PLANETS`, `POINT_NAMES_JP` など）が関数内から利用可能か確認する。(利用可能)

## 3. バックエンド実装 (`app.py`)

- [x] `/` ルートで、トランジット日付のデフォルト値（今日）を `index.html` に渡していることを確認する。
- [x] `/calculate` ルートを修正する:
    - [x] `request.form` から `transit_date` を取得する。
    - [x] `transit_date` が空でないかチェックし、空の場合はデフォルト値（今日）を設定する。
    - [x] `transit_date` 文字列を `datetime` オブジェクトに変換する。
    - [x] `calculate_julian_day` を呼び出して `jd_ut_transit` を計算する。
    - [x] `calculate_horoscope` を呼び出し、ネイタルデータ `horoscope_data` を取得する。
    - [x] `horoscope_data` からネイタルの生の角度情報 (`point_angles_raw`) を取得する（必要なら `calculate_horoscope` の戻り値に追加）。(取得済み)
    - [x] `utils.calculate_transits(jd_ut_transit, point_angles_raw)` を呼び出して `transit_data` を取得する。
    - [x] `result` 辞書に `transit_data` と `transit_date` （表示用文字列）を追加する。
    - [x] **追加:** `calculate_transits` から返された解釈文データを `result` 辞書に追加する。
    - [x] エラーハンドリング（日付変換失敗など）を追加する。(追加済み)

## 4. フロントエンド実装 (`index.html`)

- [x] `form` 内にトランジット日付入力欄を追加する:
    - [x] `<label for="transit_date">` を追加。
    - [x] `<input type="date" id="transit_date" name="transit_date">` を追加。
    - [x] `value="{{ today_date }}"` を設定してデフォルト値を表示。
    - [x] (任意) `min` 属性などで入力範囲を制限。(max のみ設定)

## 5. フロントエンド実装 (`result.html`)

- [x] トランジット計算の基準日 (`result.transit_date`) を表示する箇所を追加する。
- [x] 「トランジット天体の位置」セクションを追加する:
    - [x] `<h2>` タグで見出しを表示。
    - [x] `result.transit_data.transit_positions` が存在する場合にテーブルを表示する。
    - [x] テーブルヘッダー（例: 天体, サイン, 度数）を作成する。
    - [x] `result.transit_data.transit_positions` をループして各行を表示する。
- [x] 「トランジット - ネイタル アスペクト」セクションを追加する:
    - [x] `<h2>` タグで見出しを表示。
    - [x] `result.transit_data.transit_aspects` が存在する場合にリスト (`<ul>`) を表示する。
    - [x] リスト内をループして各アスペクト (`<li>`) を表示する（例: `{{ aspect.t_point }} {{ aspect.symbol }} {{ aspect.n_point }} ({{ aspect.type }}, オーブ: {{ '%.1f'|format(aspect.orb) }}°)`）。
- [x] **追加:** 「トランジットの読み解き」セクションを追加し、バックエンドから渡された解釈文を表示する。
- [ ] (任意) `style.css` に新しいテーブルやリスト用のスタイルを追加・調整する。

## 6. テスト

- [x] デフォルト（今日）のトランジットで計算を実行し、結果が表示されることを確認。
- [x] 未来の日付を指定して計算を実行し、結果が表示されることを確認。
- [x] 過去の日付を指定して計算を実行し、結果が表示されることを確認。
- [x] ネイタルデータ（天体位置、チャート等）がトランジット機能追加によって影響を受けていないことを確認。
- [x] 表示されるトランジット天体位置が妥当か（他のツール等と比較して）確認。
- [x] 表示されるトランジット-ネイタルアスペクトが妥当か（手計算や他のツールと比較して）確認。
- [x] 表示レイアウトが崩れていないか、各種ブラウザで確認。
- [x] 不正な日付（形式エラーなど）が入力された場合、適切に処理されるか確認。
- [ ] **追加:** 生成されたトランジットの読み解き文章が表示され、内容が妥当か確認する。

## 7. ドキュメント・その他

- [ ] 追加・修正したコードにコメントを記述する。
- [ ] (必要であれば) `README.md` や `app_improvement_plan.md` を更新する。
- [ ] Git に変更をコミットする。 