# ホロスコープ・サビアンシンボル表示アプリ 開発チェックリスト

## 1. 要件定義・設計

- [ ] **要件確認:** `horoscope_sabian_app_requirements.md` の内容をチームで確認し、実装範囲と仕様について合意する。
- [ ] **使用ライブラリ選定:** 天体計算 (`swisseph`)、(任意)ジオコーディング、(任意)チャート描画ライブラリを決定する。
- [ ] **データ形式確定:**
    - [ ] サビアンシンボルデータのJSON形式（既存のものを踏襲）。
    - [ ] `calculate_horoscope_data` 関数の戻り値のデータ構造。
    - [ ] `calculate_aspects` 関数の戻り値のデータ構造。
    - [ ] アスペクトグリッド用データの構造。
    - [ ] 簡易解釈文（総合的読み解き、アスペクト解説）のデータ構造。
- [ ] **表示設計詳細化:**
    - [ ] `result.html` に表示する各情報（入力情報、天体位置、サビアンシンボル、アスペクトリスト、アスペクトグリッド、総合的読み解き、アスペクト解説、チャート図）の具体的なレイアウトを決定する。
    - [ ] サビアンシンボル表示方法（ツールチップ、モーダル等）を決定する。
    - [ ] (任意) ホロスコープチャート図のデザイン（要素、配色など）を決定する。
- [ ] **入力フォーム設計:** `index.html` の入力フィールド項目、バリデーションルールを決定する。
- [ ] **PDF出力設計:**
    - [ ] PDFに出力するコンテンツの範囲を決定する（画面表示の全てか一部か）。
    - [ ] PDFのレイアウト、スタイルを決定する（専用CSSを準備するかなど）。
    - [ ] 使用するPDF生成ライブラリを最終決定する (例: WeasyPrint)。

## 2. データ準備

- [ ] 360個のサビアンシンボル詩文データを収集・整形し、`data/sabian_symbols.json` を作成・検証する。
- [ ] Swiss Ephemeris の天体暦データファイル群を準備し、`swe.set_ephe_path()` で正しく設定できるようにする。
- [ ] 簡易解釈文のテンプレートデータを準備・作成する（天体サイン、天体ハウス、アスペクト解説用）。JSONファイル等で管理。

## 3. バックエンド実装 (`utils.py` または対応モジュール)

- [ ] **初期設定・ヘルパー関数:**
    - [ ] `swe.set_ephe_path()` を正しく呼び出す処理を実装。
    - [ ] 惑星リスト、アスペクト定義（種類、オーブ、記号）、星座名などの定数を定義。
    - [ ] `format_degree` (度数フォーマット)、`get_sign` (サイン名取得) 関数を実装。
    - [ ] 10進数度数フォーマット関数を実装。
    - [ ] `load_interpretation_templates()`: 解釈文テンプレート読み込み処理を実装。
- [ ] **サビアンシンボル関連関数:**
    - [ ] `load_sabian_symbols()`: JSONファイル読み込み、データ格納、エラー処理を実装。
    - [ ] `get_sabian_symbol()`: 黄経とサイン名から詩文を返すロジック、サビアン度数変換ロジックを実装。
    - [ ] 生の角度情報を保持する処理を実装。
- [ ] **ホロスコープ計算関数 (`calculate_horoscope_data`):**
    - [ ] `swe.julday` を使ったユリウス日変換 (app.py側でも可)。
    - [ ] `swe.calc_ut` で主要10天体の位置計算を実装。
    - [ ] `swe.houses_ex` でASC/MC/ハウスカスプ計算を実装。
    - [ ] 計算結果（ポイント名、黄経、フォーマット済み度数、サイン、ハウス、サビアンシンボル等）を構造化して返す処理を実装。
    - [ ] 生の角度情報を保持する処理を実装。
- [ ] **アスペクト計算関数 (`calculate_aspects`):**
    - [ ] 天体ペア間の角度差計算ロジックを実装。
    - [ ] 定義されたオーブ内でアスペクトを判定するロジックを実装。
    - [ ] 結果（天体ペア、アスペクト種類、オーブ、記号）を構造化して返す処理を実装。
- [ ] **アスペクトグリッドデータ生成関数 (`generate_aspect_grid_data`):**
    - [ ] 天体リストとアスペクトリストから、グリッド表示に適したデータ構造を生成するロジックを実装。
- [ ] **簡易解釈文生成関数:**
    - [ ] `generate_general_readings()`: 天体のサイン・ハウス情報とテンプレートを基に「総合的な読み解き」文を生成するロジックを実装。
    - [ ] `generate_aspect_explanations()`: アスペクト情報とテンプレートを基に「アスペクト解説」文を生成するロジックを実装。
- [ ] **トランジット計算関数 (`calculate_transit_data`):**
    - [ ] トランジット日時のユリウス日(UT)を引数に取る。
    - [ ] `swe.calc_ut()` でトランジット天体位置を計算するロジックを実装。
    - [ ] トランジット天体のサビアンシンボル取得ロジックを実装。
    - [ ] トランジット天体とネイタル天体間のアスペクト計算ロジックを実装（専用オーブ使用）。
    - [ ] (任意) トランジット-ネイタルアスペクトの簡易解説文生成ロジックを実装。
    - [ ] 結果（トランジット天体位置、T-Nアスペクト、T-Nアスペクト解説）を構造化して返す処理を実装。

## 4. バックエンド実装 (`app.py` またはメインアプリケーションファイル)

- [ ] アプリケーション初期化時に `utils.load_sabian_symbols()`、`utils.load_interpretation_templates()` と `swe.set_ephe_path()` を呼び出す。
- [ ] **入力受付ルート (`/` または `/index`):**
    - [ ] `GET` 時: `index.html` をレンダリングする処理を実装。
- [ ] **計算実行ルート (`/calculate`):**
    - [ ] `POST` 時: フォームデータ（生年月日、時刻、場所情報）を取得する処理を実装。
        - [ ] **トランジット日時** もフォームから取得する処理を追加。
    - [ ] (地名の場合) ジオコーディング処理を実装（または呼び出し）。
    - [ ] 入力値のバリデーションとユリウス日への変換処理を実装。
        - [ ] トランジット日時もユリウス日に変換、未入力時はデフォルト値（現在日時）を設定。
    - [ ] `utils.calculate_horoscope_data()` を呼び出す。
    - [ ] `utils.calculate_aspects()` を呼び出す。
    - [ ] `utils.generate_aspect_grid_data()` を呼び出す。
    - [ ] `utils.generate_general_readings()` を呼び出す。
    - [ ] `utils.generate_aspect_explanations()` を呼び出す。
    - [ ] `utils.calculate_transit_data()` を呼び出す処理を追加。
    - [ ] 計算結果を `result.html` に渡してレンダリングする処理を実装。
        - [ ] トランジット関連データもテンプレートへ渡す。
    - [ ] 計算エラー時のエラーハンドリングと適切なレスポンスを実装。
- [ ] **PDF出力ルート (`/download_pdf`):**
    - [ ] ホロスコープ計算結果データを受け取る処理を実装 (POSTまたはセッション経由)。
    - [ ] PDF用HTMLテンプレートにデータを渡しレンダリングする処理を実装。
    - [ ] WeasyPrint等でHTMLからPDFを生成する処理を実装。
    - [ ] 生成したPDFをファイルとしてユーザーに送信する処理を実装。
        - [ ] PDFデータにトランジット情報も含まれるようにする。

## 5. フロントエンド実装 (`templates/index.html`)

- [ ] 生年月日、出生時刻、出生地（経緯度または地名）の入力フィールドを作成。
- [ ] **トランジット日時入力フィールド** (`<input type="date">` と時刻) を追加。
    - [ ] デフォルト値（例: 当日）を設定。
- [ ] 計算実行ボタンを作成。
- [ ] フォームの `action` と `method` を正しく設定。
- [ ] (任意) JavaScriptによるクライアントサイドバリデーションを実装。

## 6. フロントエンド実装 (`templates/result.html`)

- [ ] 計算に使用した入力情報を表示するセクションを作成。
- [ ] **天体リスト表示:**
    - [ ] テーブルヘッダー（天体名, サイン, 度数, ハウス, サビアンシンボルなど）を作成。
    - [ ] バックエンドから渡された天体データをループ処理し、各行を表示するテンプレート構文を記述。
    - [ ] サビアンシンボルの表示方法（全文表示のためのJS処理など）を実装。
- [ ] **天体の位置とサビアンシンボル詳細表示セクションの実装:** (要件定義書のデザインに基づき実装)
- [ ] **アスペクトリスト表示:**
    - [ ] テーブルヘッダー（天体1, 天体2, アスペクト, オーブなど）を作成。
    - [ ] バックエンドから渡されたアスペクトデータをループ処理し、各行を表示するテンプレート構文を記述。
- [ ] **アスペクトグリッド表示:**
    - [ ] `<table>` とテンプレート構文でアスペクトグリッドを表示する処理を実装。
- [ ] **総合的な読み解き表示:**
    - [ ] バックエンドから渡された解釈文を適切に表示するテンプレート構文を記述。
- [ ] **アスペクト解説表示:**
    - [ ] バックエンドから渡されたアスペクト解説文を適切に表示するテンプレート構文を記述。
- [ ] **トランジット情報表示セクションの実装:**
    - [ ] 「トランジット情報 (+計算日時)」の見出しを表示。
    - [ ] トランジット天体位置テーブル（サイン、度数、サビアン等）を表示するテンプレート構文を記述。
    - [ ] トランジット-ネイタルアスペクトリストを表示するテンプレート構文を記述。
    - [ ] (任意) トランジット-ネイタルアスペクト解説を表示するテンプレート構文を記述。
- [ ] **(任意) ホロスコープチャート表示:**
    - [ ] チャート描画用のコンテナ要素（例: `<div id="chart">`）を配置。
    - [ ] JavaScriptでバックエンドからのデータをもとにチャートを描画する処理を実装。
        - [ ] (任意) ネイタルとトランジットの二重円表示に対応。
- [ ] **PDFダウンロードボタンの実装:**
    - [ ] PDF出力ルートへPOSTリクエスト（または適切なGETリクエスト）を送信するフォーム/ボタンを設置。

## 7. スタイリング (`static/style.css`)

- [ ] 入力フォームのスタイルを調整。
- [ ] 結果表示テーブル（天体リスト、アスペクトリスト）のスタイルを調整（可読性、見やすさ）。
- [ ] サビアンシンボル表示部分のスタイル（フォント、行間、ツールチップ/モーダルのスタイル）を調整。
- [ ] (任意) ホロスコープチャートの見た目を調整。
- [ ] アスペクトグリッドのスタイルを調整。
- [ ] 総合的な読み解き、アスペクト解説セクションのスタイルを調整。
- [ ] 全体的なページレイアウト、配色を調整。
- [ ] (PDF出力用) 印刷に適した専用のスタイルシート（`print.css`など）を作成または既存CSSを調整。

## 8. テスト

- [ ] **データ準備テスト:**
    - [ ] `sabian_symbols.json` が正しく読み込まれることを確認。
    - [ ] `swisseph` の天体暦ファイルが正しく設定されていることを確認。
    - [ ] 解釈文テンプレートファイルが正しく読み込まれることを確認。
- [ ] **単体テスト (`utils.py`):**
    - [ ] `calculate_horoscope_data` が既知の入力に対して正しい天体位置、ASC/MC、ハウス、サビアンシンボルを返すかテスト。
    - [ ] `calculate_aspects` が既知の角度セットに対して正しいアスペクトを検出するかテスト。
    - [ ] `get_sabian_symbol` が各星座の境界値を含む様々な度数に対して正しい詩文を返すかテスト。
    - [ ] `generate_aspect_grid_data` が正しいグリッドデータを生成するかテスト。
    - [ ] `generate_general_readings` および `generate_aspect_explanations` が妥当な解釈文を生成するかテスト（目視確認含む）。
- [ ] **結合テスト (`app.py` 経由):**
    - [ ] 様々な生年月日・時刻・場所の組み合わせで計算を実行し、`result.html` に表示される全情報が妥当か確認。
         - 表示項目: 入力情報、天体位置、サビアンシンボル、アスペクトリスト、アスペクトグリッド、総合的読み解き、アスペクト解説。
         - **トランジット日時を指定した場合、トランジット関連情報（天体位置、T-Nアスペクト、解説）が追加で正しく表示されるか確認。**
    - [ ] 入力バリデーションエラー（不正な日付、時刻、範囲外の経緯度など）が正しく処理されるか確認。
         - トランジット日時の不正な入力に対するエラー処理も確認。
    - [ ] (ジオコーディング使用時) 地名検索が機能し、正しい経緯度が設定されるか確認。
- [ ] **フロントエンドテスト:**
    - [ ] `index.html` の入力フォームが正しく表示・動作するか確認。
         - トランジット日時入力フィールドが正しく機能するか確認。
    - [ ] `result.html` の各情報が、画像で提示されたレイアウトに近い形で正しく表示されるか確認。
         - トランジット情報セクションが正しく表示されるか確認。
    - [ ] サビアンシンボルの詳細表示（ツールチップ/モーダル等）が意図通り動作するか確認。
    - [ ] (チャート表示時) ホロスコープチャートが正しく描画されるか確認。
         - (二重円表示時) ネイタルとトランジットのチャートが正しく重ねて描画されるか確認。
- [ ] **PDF出力テスト:**
    - [ ] PDFダウンロードボタンが機能することを確認。
    - [ ] ダウンロードされたPDFファイルが破損なく開けることを確認。
    - [ ] PDFの内容が画面表示（またはPDF専用レイアウト）と一致し、情報が網羅されているか確認。
         - PDFにトランジット情報が正しく含まれているか確認。
    - [ ] PDFのレイアウト、フォント、画像の表示が適切であるか確認。
    - [ ] レスポンシブデザインの場合、異なる画面サイズで表示崩れがないか確認。
    - [ ] 主要ブラウザ（Chrome, Firefox, Safari, Edge）での動作確認。

## 9. ドキュメント・その他

- [ ] 追加・修正したPythonコード、JavaScriptコード、CSSに適切なコメントを記述する。
- [ ] `README.md` にアプリケーションの概要、セットアップ手順、必要なライブラリ、(もしあれば)APIキーの設定方法などを記載する。
- [ ] 全ての変更をバージョン管理システム（Git）にコミットし、適切なブランチ運用を行う。 