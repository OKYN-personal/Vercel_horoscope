{% extends "base.html" %}

{% block title %}ホロスコープ結果{% endblock %}

{% block content %}
<div class="container result-page">
    <h1>ホロスコープ結果</h1>

    <div class="result-section">
        <h2>入力情報</h2>
        <p>生年月日: {{ result.birth_date }} {{ result.birth_time }}</p>
        <p>出生地: {{ result.birth_place }} 
            (緯度: {{ '%.2f'|format(result.natal.latitude) if result.natal.latitude is not none else 'N/A' }}, 
             経度: {{ '%.2f'|format(result.natal.longitude) if result.natal.longitude is not none else 'N/A' }})
        </p>
        <p>タイムゾーン: {{ result.natal.timezone | default('N/A') }} / ハウスシステム: {{ result.natal.house_system | default('N/A') }}</p>
    </div>

    <div class="result-section">
        <h2>天体の位置 (ネイタル)</h2>
        <table class="positions-table">
            <thead>
                <tr>
                    <th>天体</th>
                    <th>サイン</th>
                    <th>度数</th>
                    <th>ハウス</th>
                    <th>記号</th>
                </tr>
            </thead>
            <tbody>
                {% if result.natal.positions %}
                    {% for planet_key, data in result.natal.positions.items() %}
                    <tr>
                        <td>{{ data.name_jp | default(planet_key) }}</td> {# 日本語名を使用 #}
                        <td>{{ data.sign_jp }}</td>
                        <td>{{ data.degree_formatted }}</td>
                        <td>{{ data.house if data.house is not none else '-' }}</td> {# Noneの場合はハイフン表示 #}
                        <td><span class="glyph">{{ data.glyph }}</span></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5">天体位置データがありません。</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="result-section">
        <h2>ホロスコープチャート</h2>
        <div class="chart-container" style="text-align: center;">
            {% if result.chart_svg %}
                {{ result.chart_svg | safe }} {# SVGを安全に描画 #}
            {% else %}
                <p style="color: #aaa;">（ホロスコープチャートの生成に失敗しました）</p>
            {% endif %}
        </div>
    </div>

    <div class="result-section">
        <h2>アスペクト (ネイタル)</h2>
        {% if result.natal.aspects %}
            <ul class="aspect-list">
            {% for aspect in result.natal.aspects %}
                <li>
                    <span class="glyph">{{ aspect.planet1_glyph }}</span> {{ aspect.aspect_glyph }} <span class="glyph">{{ aspect.planet2_glyph }}</span>
                    ({{ aspect.planet1_jp | default(aspect.planet1) }} - {{ aspect.planet2_jp | default(aspect.planet2) }}) {# 日本語名を使用 #}
                    オーブ: {{ aspect.orb }}°
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>ネイタルアスペクト情報がありません。</p>
        {% endif %}
        
        <h3>アスペクトグリッド (ネイタル)</h3>
        {% if result.aspect_grid and result.aspect_grid.planets and result.aspect_grid.grid %}
            <table class="aspect-grid-table">
                <thead>
                    <tr>
                        <th></th> {# 左上の空セル #}
                        {% for p_name in result.aspect_grid.planets %}
                            <th><span class="glyph">{{ result.natal.positions[p_name].glyph if p_name in result.natal.positions else p_name }}</span></th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for p1_name in result.aspect_grid.planets %}
                        <tr>
                            <th><span class="glyph">{{ result.natal.positions[p1_name].glyph if p1_name in result.natal.positions else p1_name }}</span></th>
                            {% for p2_name in result.aspect_grid.planets %}
                                {% set cell_value = result.aspect_grid.grid[p1_name][p2_name] %}
                                <td class="aspect-{{ cell_value.replace('☌','conj').replace('∗','sext').replace('□','squa').replace('△','trin').replace('☍','oppo') if cell_value and cell_value != 'X' else '' }}">
                                    <span class="glyph">{{ cell_value }}</span>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>アスペクトグリッド情報がありません。</p>
        {% endif %}
    </div>
    
    <div class="result-section">
        <h2>天体のサイン解説</h2>
        <div class="interpretation">
            {% set interp_order = ['Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'] %}
            {% if result.interpretations and result.interpretations.planet_in_sign %}
                {% for planet_key in interp_order %}
                    {% if planet_key in result.interpretations.planet_in_sign %}
                        {% set interp_data = result.interpretations.planet_in_sign[planet_key] %}
                        {% set planet_glyph = result.natal.positions[planet_key].glyph | default('') %}
                        <div class="interpretation-item" style="margin-bottom: 1em;">
                            <h4><span class="glyph">{{ planet_glyph }}</span> {{ interp_data.key }} 解説</h4>
                            <p class="interpretation-text">{{ interp_data.text }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
                {# TODO: 他の天体 (Uranusなど) のサイン解説も同様に追加する場合 #}
            {% else %}
                 <p style="color: #aaa;">天体のサイン解釈情報がありません。</p>
            {% endif %}
        </div>
    </div>

    <div class="result-section">
        <h2>天体のハウス解説</h2>
        <div class="interpretation">
             {% set interp_order = ['Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'] %}
             {% if result.interpretations and result.interpretations.planet_in_house %}
                {% for planet_key in interp_order %}
                    {% if planet_key in result.interpretations.planet_in_house %}
                        {% set interp_data = result.interpretations.planet_in_house[planet_key] %}
                        {% set planet_glyph = result.natal.positions[planet_key].glyph | default('') %}
                        <div class="interpretation-item" style="margin-bottom: 1em;">
                            <h4><span class="glyph">{{ planet_glyph }}</span> {{ interp_data.key }} 解説</h4>
                            <p class="interpretation-text">{{ interp_data.text }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
                 {# TODO: 他の天体 (Uranusなど) のハウス解説も同様に追加する場合 #}
            {% else %}
                 <p style="color: #aaa;">天体のハウス解釈情報がありません。</p>
            {% endif %}
        </div>
    </div>

    <div class="result-section">
        <h2>総合的な読み解き (詳細) - サビアンシンボル</h2>
        <div class="interpretation">
            {% if result.natal.sabian and result.natal.sabian is mapping and result.natal.sabian | length > 0 %}
                {% for planet_key, sabian_data in result.natal.sabian.items() %}
                    {% set planet_data = result.natal.positions.get(planet_key) %}
                    {% if planet_data %}
                        <div class="sabian-interpretation" style="margin-bottom: 1em;">
                            <h4>
                                <span class="glyph">{{ planet_data.glyph }}</span>
                                {{ planet_data.name_jp | default(planet_key) }}のサビアンシンボル: {{ sabian_data.symbol }} {# 日本語名を使用 #}
                            </h4>
                            <p class="interpretation-text" style="white-space: pre-wrap;">{{ sabian_data.interpretation }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p style="color: #aaa;">サビアンシンボルの解釈情報がありません。</p>
            {% endif %}
        </div>
    </div>

     <div class="result-section">
        <h2>アスペクト解説 (ネイタル)</h2>
        <div class="interpretation">
             {# アスペクト解釈を表示 #}
             {% if result.interpretations and result.interpretations.aspects %}
                 <ul class="aspect-interpretation-list" style="padding-left: 0; list-style: none;">
                 {% for aspect_interp in result.interpretations.aspects %}
                     <li style="margin-bottom: 1em;">
                         <span class="glyph">{{ aspect_interp.planet1_glyph }}</span> {{ aspect_interp.aspect_glyph }} <span class="glyph">{{ aspect_interp.planet2_glyph }}</span>
                         {# 日本語名を使用 #}
                         <strong>{{ aspect_interp.planet1_jp | default(aspect_interp.planet1) }} - {{ aspect_interp.planet2_jp | default(aspect_interp.planet2) }} {{ aspect_interp.aspect_type }}</strong>
                         <p class="interpretation-text" style="margin-top: 0.3em;">{{ aspect_interp.text }}</p>
                     </li>
                 {% endfor %}
                 </ul>
             {% else %}
                 <p style="color: #aaa;">アスペクトの解釈情報がありません。</p>
             {% endif %}
        </div>
    </div>

    {% if result.transit %}
    <div class="result-section">
        <h2>トランジット情報 ({{ result.transit_date }})</h2>
        <h3>トランジット天体位置</h3>
        <table class="positions-table">
             <thead>
                <tr>
                    <th>天体</th>
                    <th>サイン</th>
                    <th>度数</th>
                    <th>記号</th>
                </tr>
            </thead>
            <tbody>
                {% if result.transit.positions %}
                    {% for planet_key, data in result.transit.positions.items() %}
                    <tr>
                        <td>{{ data.name_jp | default(planet_key) }}</td> {# 日本語名を使用 #}
                        <td>{{ data.sign_jp }}</td>
                        <td>{{ data.degree_formatted }}</td>
                        <td><span class="glyph">{{ data.glyph }}</span></td>
                    </tr>
                    {% endfor %}
                {% else %}
                     <tr><td colspan="4">トランジット天体位置データがありません。</td></tr>
                {% endif %}
            </tbody>
        </table>

        <h3>アスペクト解説 (トランジット - ネイタル)</h3>
         <div class="interpretation">
            {% if result.transit.aspects %}
                <ul class="aspect-list">
                {% for aspect in result.transit.aspects %}
                    <li>
                        <span class="glyph">{{ aspect.planet1_glyph }}</span> {{ aspect.aspect_glyph }} <span class="glyph">{{ aspect.planet2_glyph }}</span>
                        {# 日本語名を使用 #}
                        ({{ aspect.planet1_jp | default(aspect.planet1) }} - {{ aspect.planet2_jp | default(aspect.planet2) }})
                        オーブ: {{ aspect.orb }}°
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>トランジットアスペクト情報がありません。</p>
            {% endif %}
         </div>
         
        <h3>サビアンシンボル (トランジット)</h3>
        <div class="interpretation">
            {% if result.transit.sabian and result.transit.sabian is mapping and result.transit.sabian | length > 0 %}
                {% for planet_key, sabian_data in result.transit.sabian.items() %}
                    {% set planet_data = result.transit.positions.get(planet_key) %}
                    {% if planet_data %}
                        <div class="sabian-interpretation" style="margin-bottom: 1em;">
                            <h4>
                                <span class="glyph">{{ planet_data.glyph }}</span>
                                {{ planet_data.name_jp | default(planet_key) }}のサビアンシンボル: {{ sabian_data.symbol }} {# 日本語名を使用 #}
                            </h4>
                            <p class="interpretation-text" style="white-space: pre-wrap;">{{ sabian_data.interpretation }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p style="color: #aaa;">トランジットのサビアンシンボル解釈情報がありません。</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="download-pdf-section" style="margin-top: 2em; text-align: center;">
        {# PDFダウンロードボタン -> result.pdf_url があれば有効化 #}
        {% if result.pdf_url %}
            <a href="{{ result.pdf_url }}" class="button" target="_blank">結果をPDFでダウンロード</a>
        {% else %}
            <button type="button" onclick="alert('PDFダウンロードの準備ができていません。');" class="button" disabled>結果をPDFでダウンロード</button>
        {% endif %}
    </div>

    <div class="back-link" style="text-align: center; margin-top: 1em;">
        <a href="{{ url_for('main.index') }}">入力画面に戻る</a>
    </div>
</div>

<style>
/* result_sample.html にあったスタイルを一部流用・調整 */
.result-page h1 { margin-bottom: 1em; }
.result-section {
    background-color: #f9f9f9;
    padding: 1.5em;
    margin-bottom: 1.5em;
    border-radius: 8px;
    border: 1px solid #eee;
}
.result-section h2 {
    color: #337ab7;
    border-bottom: 2px solid #337ab7;
    padding-bottom: 0.5em;
    margin-top: 0;
    margin-bottom: 1em;
    font-size: 1.5em;
}
.result-section h3 {
    color: #555;
    margin-top: 1.5em;
    margin-bottom: 0.8em;
    font-size: 1.2em;
}
.positions-table th, .positions-table td,
.aspect-grid-table th, .aspect-grid-table td {
    padding: 0.5em;
    border: 1px solid #ddd;
    text-align: center;
}
.positions-table th, .aspect-grid-table th {
    background-color: #f0f8ff;
    font-weight: bold;
}
.positions-table td:nth-child(1), .positions-table td:nth-child(2) {
    text-align: left;
}
.aspect-grid-table td {
    min-width: 30px; /* グリッドのセル幅 */
}
.aspect-list { padding-left: 0; list-style: none; }
.aspect-list li { margin-bottom: 0.5em; font-size: 0.9em; }
.glyph { font-family: "Astrological Symbols", "Apple Symbols", "Arial Unicode MS", sans-serif; font-size: 1.2em; } /* フォールバックフォント追加 */

/* アスペクト記号の色 (例) */
.aspect-conj { color: green; }
.aspect-sext { color: blue; }
.aspect-squa { color: red; }
.aspect-trin { color: darkblue; }
.aspect-oppo { color: darkred; }

/* SVG内のスタイル調整 (オプション) */
.chart-container svg {
    max-width: 100%;
    height: auto;
}

/* 解釈文の改行を保持 */
.interpretation-text {
    white-space: pre-wrap; 
}

/* 解釈アイテムのスタイル調整 (任意) */
.interpretation-item h4 {
    color: #337ab7;
    margin-bottom: 0.5em;
}

</style>
{% endblock %} 