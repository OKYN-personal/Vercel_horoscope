# ホロスコープ・サビアンシンボル表示アプリ 開発手順書

## 1. 概要

この手順書は、ユーザー指定の出生情報に基づいてネイタルホロスコープを計算し、天体位置、アスペクト、および関連するサビアンシンボルを表示するウェブアプリケーションを開発するための手順を記述します。

## 2. 開発環境

-   Python (Flaskフレームワーク)
-   `swisseph` ライブラリ (天体計算用)
-   HTML, CSS, JavaScript (フロントエンド)
-   (任意) ジオコーディングライブラリ/API (地名からの経緯度変換用)
-   (任意) チャート描画ライブラリ (JavaScript)
-   (任意だが推奨) `WeasyPrint` ライブラリ (PDF出力用、HTML/CSSベース)

## 3. データ準備

1.  **サビアンシンボルデータの作成:**
    -   360個のサビアンシンボル（各星座宮の1度から30度まで）の日本語詩文データをJSONファイル形式で作成します（例: `data/sabian_symbols.json`）。
    -   JSON構造例 (既存の `sabian_development.md` 参照):
        ```json
        {
          "Aries": {
            "1": "牡羊座1度: 女性が水から上がり、アザラシも上がり彼女を抱く。",
            ...
          },
          ...
        }
        ```
2.  **Swiss Ephemeris データファイル:**
    -   `swisseph` ライブラリが要求する天体暦データファイル群を適切なディレクトリに配置し、ライブラリからアクセスできるように設定します。

## 4. バックエンド実装 (`utils.py` または対応するモジュール)

1.  **初期設定・ヘルパー関数:**
    -   `swe.set_ephe_path()`: 天体暦データファイルのパスを設定。
    -   惑星や感受点のリスト、アスペクトの種類とオーブの定義、星座名の定義など、共通して使用する定数を定義します。
    -   度数を「サイン 度 分 秒」形式にフォーマットする関数 (`format_degree`)。
    -   度数を10進数形式（例: 25.6）にフォーマットする関数。
    -   サイン名を取得する関数 (`get_sign`)。
    -   **簡易解釈文テンプレートの読み込み:**
        -   `load_interpretation_templates()`: 天体サイン、天体ハウス、アスペクトに関する解釈文テンプレートをJSONファイル等から読み込み、データ構造に格納する関数を作成。
2.  **サビアンシンボル関連関数 (既存の `sabian_development.md` 参照):**
    -   `load_sabian_symbols()`: `sabian_symbols.json` を読み込み、グローバル変数などに格納。
    -   `get_sabian_symbol(longitude, sign_name_en)`: 黄経とサイン英語名から対応するサビアン詩文を取得。
3.  **ホロスコープ計算関数:**
    -   `calculate_horoscope_data(julian_day_ut, birth_lat, birth_lon)` (仮称):
        -   引数: ユリウス日(UT)、出生地の緯度、経度。
        -   処理:
            -   `swe.calc_ut()` を使用して主要10天体の黄経、黄緯、距離、速度などを計算。
            -   `swe.houses_ex()` を使用してASC, MCおよび各ハウスカスプの黄経を計算 (プランシーダスシステム等)。
            -   計算結果を整形し、各ポイント（天体、ASC, MC）について、名前、黄経(度数)、黄経(フォーマット済み文字列)、サイン名(日本語/英語)、サイン(度数内)、ハウス番号、サビアンシンボル( `get_sabian_symbol` を呼び出し) などを辞書のリストとして格納。
            -   ネイタルの生の角度情報も別途保持しておく（アスペクト計算用）。
        -   戻り値: `{'points': [ {'name': '太陽', 'longitude': ..., 'sabian_symbol': ...}, ... ], 'houses': [house1_cusp, ...], 'point_angles_raw': {...} }` のような辞書。
4.  **アスペクト計算関数:**
    -   `calculate_aspects(point_angles_raw)` (仮称):
        -   引数: 天体・感受点の生の角度情報を含む辞書。
        -   処理: 定義されたアスペクトの組み合わせとオーブに基づき、天体間のアスペクトを検出。
        -   戻り値: `[ {'point1': '太陽', 'point2': '月', 'type': 'Trine', 'orb': 1.2, 'symbol': '△'}, ... ]` のようなアスペクト情報のリスト。
    -   `generate_aspect_grid_data(points, aspects)` (仮称):
        -   引数: 天体情報リスト、アスペクト情報リスト。
        -   処理: アスペクトグリッド表示用の2次元配列または辞書のリストを生成する。各セルには対応するアスペクト記号を格納。
        -   戻り値: グリッドデータ。
5.  **簡易解釈文生成関数:**
    -   `generate_general_readings(points, interpretation_templates)` (仮称):
        -   引数: 天体情報リスト、読み込んだ解釈文テンプレート。
        -   処理: 各主要天体について、そのサインとハウスに対応する解釈文テンプレートを組み合わせ、簡易的な「総合的な読み解き」文を生成する。
        -   戻り値: 天体ごとの解釈文を含む辞書またはリスト。
    -   `generate_aspect_explanations(aspects, interpretation_templates)` (仮称):
        -   引数: アスペクト情報リスト、読み込んだ解釈文テンプレート。
        -   処理: 各主要アスペクトについて、対応する解釈文テンプレートを基に「アスペクト解説」文を生成する。
        -   戻り値: アスペクトごとの解説文を含むリスト。
6.  **トランジット計算関数 (既存の `transit_development.md` を参考にする):**
    -   `calculate_transit_data(jd_ut_transit, natal_points_data, interpretation_templates)` (仮称):
        -   引数: トランジット日時のユリウス日(UT)、ネイタル天体データ (生の角度情報などを含む)、解釈文テンプレート。
        -   処理:
            -   `swe.calc_ut()` を使用して、指定された `jd_ut_transit` における主要トランジット天体（太陽～冥王星）の位置を計算。
            -   各トランジット天体のサビアンシンボルを取得 ( `get_sabian_symbol` を利用)。
            -   トランジット天体とネイタル天体・感受点間のアスペクトを計算 (専用のトランジット用オーブを使用)。
            -   (任意) 計算されたトランジット-ネイタルアスペクトに対する簡易解説文を生成。
        -   戻り値: `{'transit_positions': [...], 'transit_natal_aspects': [...], 'transit_aspect_explanations': [...]}` のような辞書。

## 5. バックエンド実装 (`app.py` またはメインアプリケーションファイル)

1.  **初期化処理:**
    -   アプリケーション起動時に `utils.load_sabian_symbols()`、`utils.load_interpretation_templates()` と `swe.set_ephe_path()` を呼び出す。
2.  **入力受付ルート (例: `/`):**
    -   `GET` リクエスト: 入力フォーム (`index.html`) を表示。
    -   `POST` リクエスト (`/calculate` などに対応):
        -   フォームから生年月日、時刻、経緯度（または地名）、**トランジット日時**を取得。
        -   (地名の場合) ジオコーディング処理で経緯度に変換。
        -   入力値を検証し、生年月日・時刻をユリウス日(UT)に変換 (`swe.julday`)。
        -   トランジット日時もユリウス日(UT)に変換。トランジット日時が未入力の場合は現在日時をデフォルトとする。
        -   `utils.calculate_horoscope_data()` を呼び出しネイタルホロスコープデータを取得。
        -   `utils.calculate_aspects()` を呼び出しネイタルアスペクトデータを取得。
        -   `utils.generate_aspect_grid_data()` を呼び出しネイタルアスペクトグリッドデータを取得。
        -   `utils.generate_general_readings()` を呼び出しネイタルの総合的な読み解きデータを取得。
        -   `utils.generate_aspect_explanations()` を呼び出しネイタルアスペクト解説データを取得。
        -   `utils.calculate_transit_data()` を呼び出しトランジット関連データを取得。
        -   取得した全データを整形し、`result.html` に渡してレンダリング。
        -   エラー発生時はエラーメッセージと共に `index.html` にリダイレクトまたはエラーページを表示。
3.  **PDF出力ルート (例: `/download_pdf`):**
    -   `POST` リクエスト (またはセッションを利用してGETリクエスト):
        -   `/calculate` で生成・セッションに保存した、あるいはフォームから再送信されたホロスコープ関連データを受け取る。
        -   `render_template` を使用して、PDF出力専用のHTMLテンプレート (または `result.html` を流用しPDF用のスタイル調整を行う) にデータを渡し、HTML文字列を生成する。
            - PDF専用テンプレートは、印刷に適したレイアウトやスタイルシートを適用する。
        -   `WeasyPrint` を使用して、生成されたHTML文字列からPDFオブジェクトを作成する。
        -   `flask.send_file` や適切なレスポンスヘッダーを設定し、生成されたPDFをユーザーにダウンロードさせる。
            ```python
            from flask import send_file
            from weasyprint import HTML
            import io

            # ... (ルート定義内で) ...
            # html_for_pdf = render_template('pdf_template.html', **data_for_template)
            # pdf_bytes = HTML(string=html_for_pdf).write_pdf()
            # return send_file(
            #     io.BytesIO(pdf_bytes),
            #     as_attachment=True,
            #     download_name='horoscope_result.pdf',
            #     mimetype='application/pdf'
            # )
            ```
            - PDFにはネイタル情報とトランジット情報の両方を含めるようにデータを渡す。

## 6. フロントエンド実装 (`templates/index.html`)

1.  **入力フォームの作成:**
    -   生年月日（年・月・日）、出生時刻（時・分）、出生地の経緯度（または地名検索フィールド）を入力するためのフォーム要素を配置。
    -   **トランジット日時入力フィールド** (`<input type="date">` および時刻入力) を追加。デフォルト値を設定 (例: 当日)。
    -   送信ボタンを配置。
    -   (任意) JavaScriptによる入力値のクライアントサイドバリデーション。

## 7. フロントエンド実装 (`templates/result.html`)

1.  **結果表示セクションの作成:**
    -   **入力情報表示:** 計算に使用した生年月日、時刻、場所、**トランジット計算日時**を表示。
    -   **天体リスト表示 (ネイタル):**
        -   テーブル形式で、各天体・感受点の名前、サイン、度数、ハウス、サビアンシンボル（詩文）を表示。
        -   サビアン詩文が長い場合はツールチップやクリックで詳細表示するなどの工夫をJavaScriptで実装。
    -   **天体の位置とサビアンシンボル詳細表示セクション:** (要件定義書に基づき、別途専用セクションを設けるか、上記の天体リストに統合するか検討)
    -   **アスペクトリスト表示:**
        -   テーブル形式で、アスペクトを形成する天体ペア、アスペクトの種類（記号も）、オーブを表示。
    -   **アスペクトグリッド表示:**
        -   `<table>` を使用して、バックエンドから渡されたグリッドデータを表示する。
    -   **総合的な読み解き表示:**
        -   バックエンドから渡された天体ごとの解説文を整形して表示する。
    -   **アスペクト解説表示:**
        -   バックエンドから渡されたアスペクトごとの解説文を整形して表示する。
    -   **トランジット情報表示セクション:**
        -   「トランジット情報 (YYYY-MM-DD HH:MM)」のような見出しを表示。
        -   **トランジット天体位置テーブル:** 各トランジット天体のサイン、度数、(あれば)サビアンシンボルを表示。
        -   **トランジット-ネイタル アスペクトリスト:** トランジット天体、アスペクト記号、ネイタル天体、アスペクト種類、オーブを表示。
        -   **(任意) トランジット-ネイタル アスペクト解説:** バックエンドから渡された解説文を表示。
    -   **(任意) ホロスコープチャート表示:**
        -   `<canvas>` タグやSVGを使い、JavaScriptのチャート描画ライブラリでホロスコープ図を描画。
        -   **(任意) 二重円 (バイホイール) 表示:** ネイタルチャートとトランジットチャートを重ねて描画するロジックを実装 (ライブラリが対応している場合)。
    -   **PDFダウンロードボタン:**
        -   `<form action="{{ url_for('download_pdf') }}" method="post">` (またはJavaScript経由でデータを送信) で、PDFダウンロードをトリガーするボタンを設置。
            - 計算結果を再計算せずにPDF化する場合、計算結果をhiddenフィールドに含めるか、サーバーサイドセッションに保存したID等を送信する。
2.  **スタイリング (`static/style.css`):**
    -   入力フォーム、結果表示テーブル、チャート図などの見た目を整える。
    -   サビアンシンボルの詩文が読みやすいようにフォントや行間を調整。

## 8. テスト

-   **単体テスト:** `utils.py` の各計算関数（天体位置、アスペクト、サビアン取得）が正しい値を返すか、既知のデータと比較してテストする。
-   **結合テスト:**
    -   様々な入力値（境界値含む）でホロスコープを計算させ、表示結果が妥当であることを確認。
    -   特定の日時における天体位置やサビアンシンボルが、他の信頼できるソースと一致するか確認。
    -   入力エラー（不正な日付、時刻など）が適切に処理されるか確認。
-   **フロントエンドテスト:**
    -   表示レイアウトが崩れていないか、主要なブラウザで確認。
    -   サビアンシンボルの詳細表示機能などが正しく動作するか確認。
    -   チャート描画が正しく行われるか確認。
    -   PDFダウンロードボタンが機能し、PDFが正しくダウンロードされるか確認。
        -   ダウンロードされたPDFの内容が画面表示と一致し、レイアウトが適切か確認。
        -   PDFにネイタル情報とトランジット情報の両方が含まれていることを確認。
-   **フロントエンドテスト:**
    -   表示レイアウトが崩れていないか、主要なブラウザで確認。
    -   サビアンシンボルの詳細表示機能などが正しく動作するか確認。
    -   チャート描画が正しく行われるか確認。
    -   PDFダウンロードボタンが機能し、PDFが正しくダウンロードされるか確認。
        -   ダウンロードされたPDFの内容が画面表示と一致し、レイアウトが適切か確認。
        -   PDFにネイタル情報とトランジット情報の両方が含まれていることを確認。
    -   **トランジット機能テスト:**
        -   トランジット日時を指定した場合としない場合（デフォルト）で正しく動作するか確認。
        -   未来や過去のトランジット日時を指定して、トランジット天体位置、T-Nアスペクトが計算・表示されるか確認。
        -   表示されるトランジットデータが他の信頼できるソースと一致するか確認。

## 9. ドキュメント

-   コード内に適切なコメントを追加する。
-   (必要であれば) `README.md` にセットアップ方法、使用ライブラリ、APIキー設定（ジオコーディング等）について記述する。 